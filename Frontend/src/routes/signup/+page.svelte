<script lang="ts">
  import type {Notification, Registration} from '$type';
  import {Steps, StepsItem, Input} from '$component';
  import {UserIcon, PasswordIcon} from '$icon';
  import {currentStep} from '$store';
  import {get} from 'svelte/store';
  import {notify} from '$lib';

  const {form}: {form: Notification & Registration} = $props();

  let qr = $state() as string;
  let secret = $state() as string;
  let username = $state() as string;
  let recovery = $state() as string[];
  let anchor = $state() as HTMLAnchorElement;

  $effect(() => {
    if (form?.message) notify(form.message, form.type);
    if (form?.step) currentStep.set(Number(form?.step));

    if (form?.secret || form?.secret === '') secret = form.secret;
    if (form?.username) username = form.username;
    if (form?.recovery) recovery = form.recovery;
    if (form?.qr) qr = form.qr;
  });

  function copyRecovery() {
    navigator.clipboard.writeText(recovery.join('\n'));
  }

  function downloadRecovery() {
    const text = recovery.join('\n');
    const blob = new Blob([text], {type: 'text/plain'});
    anchor.href = URL.createObjectURL(blob);
    anchor.click();
  }

  function backStep() {
    let step = get(currentStep) - 1;
    step = step === 5 && !secret ? 2 : step;
    currentStep.set(step);
  }
</script>

<svelte:head>
  <title>ShadowSelf - Sign Up</title>
  <meta name="description" content="Sign up and create your account to start using ShadowSelf today" />
</svelte:head>

<Steps>
  <StepsItem {backStep} index={1} action="init">
    <h1>Create an account</h1>
    <div class="flex justify-end gap-6">
      <label for="username">Username</label>
      <Input type="text" icon={UserIcon} name="username" placeholder="mountain eagle" />
    </div>
    <div class="flex justify-end gap-6">
      <label for="password">Password</label>
      <Input type="password" icon={PasswordIcon} name="password" placeholder="correct horse battery staple" />
    </div>
    <p>Already have an account? <a href="/login">Login</a></p>
    <button type="submit">Next</button>
  </StepsItem>
  <StepsItem {backStep} index={2} action="askOTP">
    <h1>Hello {username},<br /> Would you like to enable 2FA now?</h1>
    <p>
      Two-Factor Authentication (2FA) is a security feature<br />
      that adds an extra layer of protection to your account when logging in
    </p>
    <button name="enable" type="submit">Enable 2FA</button>
    <button class="alt" name="skip" type="submit">Skip this step</button>
  </StepsItem>
  <StepsItem {backStep} index={3} action="showOTP">
    <h1>Scan the QR code With your authenticator app</h1>
    <img src={qr} alt="QR Code" width="200" class="w-64 shadow-lg shadow-white/15" />
    <div class="flex w-full flex-col gap-2">
      <p>Alternatively, you can paste this secret:</p>
      <p class="rounded-xl bg-neutral-800/50 p-3 font-bold">{secret}</p>
      <p class="text-sm text-red-500">Make sure to use 'SHA512' as the algorithm</p>
    </div>
    <button type="submit">Next</button>
  </StepsItem>
  <StepsItem {backStep} index={4} action="checkOTP">
    <h1>Enter the verification token</h1>
    <p>Enter the verification token that was generated by your authenticator app</p>
    <input type="number" name="token" class="w-full" required />
    <button type="submit">Verify</button>
  </StepsItem>
  <StepsItem {backStep} index={5} action="showRecovery">
    <h1>Store safely these recovery codes</h1>
    <p>
      Store these recovery codes somewhere safe, you will need<br />
      them to restore your account in case you lose access to your 2FA method.
    </p>
    <div class="grid grid-cols-2 gap-4 rounded-xl bg-neutral-800/50 p-4">
      {#each recovery as code, index (index)}
        <p>{code}</p>
      {/each}
    </div>
    <div class="flex justify-evenly">
      <button type="button" onclick={copyRecovery} class="alt">Copy to clipboard</button>
      <button type="button" onclick={downloadRecovery} class="alt">Download as txt</button>
      <a bind:this={anchor} aria-label="Download" href="/" download="ShadowSelf-recovery-codes.txt" class="hidden"></a>
    </div>
    <button type="submit">Next</button>
  </StepsItem>
  <StepsItem {backStep} index={6} action="askBilling">
    <h1>Would you like to add a billing method now?</h1>
    <p>
      You will need a payment method to use ShadowSelf<br />
      We accept both credit cards and crypto currency
    </p>
    <button name="add" type="submit">Add Payment</button>
    <button class="alt" name="skip" type="submit">Skip for now</button>
  </StepsItem>
  <StepsItem {backStep} index={7} action="addBilling">
    <h1>Add a billing method</h1>
    <p>Not implemented yet.</p>
    <button type="submit">Add Billing</button>
  </StepsItem>
  <StepsItem {backStep} index={8} action="create">
    <h1>And we're done!</h1>
    <p>
      Just click the button below<br />
      to finish setting up your account
    </p>
    <button type="submit">Create the account</button>
    <p class="-mb-6 text-sm text-neutral-400">
      By continuing, you agree to both our <br />
      <a href="/terms">Terms of Service</a> and <a href="/privacy-policy">Privacy Policy</a>
    </p>
  </StepsItem>
</Steps>

<style lang="postcss">
  h1 {
    @apply -mt-4 mb-4 text-4xl font-bold text-neutral-300;
  }
</style>
